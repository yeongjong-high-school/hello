<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>스마트팜 원격 제어</title>
  <style>
    body {
      font-family: 'Noto Sans KR', sans-serif;
      background: #f0f8ff;
      padding: 30px;
      color: #333;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    h1 {
      color: #2e7d32;
      margin-bottom: 40px;
      text-shadow: 1px 1px 3px #a5d6a7;
      text-align: center;
    }
    .card {
      background: #ffffff;
      border-radius: 12px;
      box-shadow: 0 4px 8px rgba(46, 125, 50, 0.15);
      padding: 30px;
      width: 320px;
      margin-bottom: 30px;
      text-align: center;
      user-select: none;
      position: relative;
    }
    .status {
      font-size: 24px;
      font-weight: 700;
      color: #1b5e20;
      margin-bottom: 10px;
      text-shadow: 1px 1px 2px #a5d6a7;
    }
    .alert {
      color: #d32f2f;
      font-weight: 700;
      margin-top: 8px;
      font-size: 14px;
      min-height: 20px;
    }
    .btn-group button {
      background-color: #388e3c;
      border: none;
      color: white;
      padding: 12px 24px;
      margin: 8px 12px;
      border-radius: 10px;
      font-weight: 600;
      cursor: pointer;
      font-size: 16px;
      transition: background-color 0.25s ease;
    }
    .btn-group button:hover:not(:disabled) {
      background-color: #2e7d32;
    }
    .btn-group button:disabled {
      background-color: #a5d6a7;
      cursor: not-allowed;
    }
    input[type="number"] {
      width: 80px;
      font-size: 16px;
      padding: 6px;
      border-radius: 6px;
      border: 1px solid #ccc;
      margin-right: 10px;
      text-align: center;
    }
    #community {
      width: 600px;
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 4px 8px rgba(46, 125, 50, 0.15);
      padding: 20px;
      margin-top: 40px;
    }
    #community h2 {
      color: #2e7d32;
      margin-bottom: 20px;
      text-align: center;
    }
    #postInput {
      width: 100%;
      height: 60px;
      padding: 10px;
      font-size: 16px;
      border-radius: 10px;
      border: 1px solid #ccc;
      resize: none;
      margin-bottom: 10px;
    }
    #addPostBtn {
      background-color: #388e3c;
      border: none;
      color: white;
      padding: 10px 20px;
      border-radius: 10px;
      font-weight: 600;
      cursor: pointer;
      font-size: 16px;
      float: right;
      transition: background-color 0.25s ease;
    }
    #addPostBtn:hover {
      background-color: #2e7d32;
    }
    .post {
      border-top: 1px solid #ddd;
      padding: 10px 0;
    }
    .post time {
      font-size: 12px;
      color: #666;
      float: right;
    }
    .post p {
      margin: 5px 0 10px;
      white-space: pre-wrap;
    }
    .comment {
      background: #e8f5e9;
      padding: 8px 12px;
      border-radius: 8px;
      margin-bottom: 6px;
      font-size: 14px;
    }
    .comment-input {
      display: flex;
      gap: 8px;
      margin-top: 6px;
    }
    .comment-input input {
      flex-grow: 1;
      padding: 6px 10px;
      border-radius: 8px;
      border: 1px solid #ccc;
      font-size: 14px;
    }
    .comment-input button {
      background-color: #388e3c;
      border: none;
      color: white;
      padding: 6px 12px;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      font-size: 14px;
      transition: background-color 0.25s ease;
    }
    .comment-input button:hover {
      background-color: #2e7d32;
    }
  </style>
</head>
<body>
  <h1>스마트팜 원격 제어</h1>

  <div class="card">
    <div class="status" id="tempStatus">온도: 25°C</div>
    <div id="tempAlert" class="alert"></div>
    <div class="btn-group">
      <button onclick="changeTemp(1)">온도 올리기 ▲</button>
      <button onclick="changeTemp(-1)">온도 내리기 ▼</button>
    </div>
  </div>

  <div class="card">
    <div class="status" id="humidityStatus">습도: 60%</div>
    <div id="humidityAlert" class="alert"></div>
    <div class="btn-group">
      <button onclick="changeHumidity(5)">습도 올리기 ▲</button>
      <button onclick="changeHumidity(-5)">습도 내리기 ▼</button>
    </div>
  </div>

  <div class="card">
    <div class="status" id="waterTankStatus">물탱크: 100%</div>
    <div id="waterTankAlert" class="alert"></div>
    <div class="btn-group" style="flex-wrap: wrap; justify-content: center;">
      <button id="wateringStartBtn" onclick="startWatering()">물주기 시작</button>
      <button id="wateringStopBtn" onclick="stopWatering()" disabled>물주기 멈추기</button>
      <button id="fillingStartBtn" onclick="startFilling()">물탱크 채우기 시작</button>
      <button id="fillingStopBtn" onclick="stopFilling()" disabled>물탱크 채우기 멈추기</button>
    </div>

    <div style="margin-top: 15px; text-align: center;">
      <input id="wateringDuration" type="number" min="1" placeholder="초 단위" />
      <button id="wateringTimedStartBtn" onclick="startWateringForDuration()">설정한 시간 동안 물주기</button>
    </div>
  </div>

  <div id="community">
    <h2>커뮤니티</h2>
    <textarea id="postInput" placeholder="게시글 작성..."></textarea>
    <button id="addPostBtn" onclick="addPost()">게시글 등록</button>
    <div id="postList"></div>
  </div>

  <script>
    let temperature = 25;
    let humidity = 60;
    let waterTankLevel = 100;

    const tempDisplay = document.getElementById("tempStatus");
    const tempAlert = document.getElementById("tempAlert");
    const humidityDisplay = document.getElementById("humidityStatus");
    const humidityAlert = document.getElementById("humidityAlert");
    const waterTankDisplay = document.getElementById("waterTankStatus");
    const waterTankAlert = document.getElementById("waterTankAlert");

    const wateringStartBtn = document.getElementById("wateringStartBtn");
    const wateringStopBtn = document.getElementById("wateringStopBtn");
    const fillingStartBtn = document.getElementById("fillingStartBtn");
    const fillingStopBtn = document.getElementById("fillingStopBtn");
    const wateringTimedStartBtn = document.getElementById("wateringTimedStartBtn");
    const wateringDurationInput = document.getElementById("wateringDuration");

    const postInput = document.getElementById("postInput");
    const postListDiv = document.getElementById("postList");

    let wateringInterval = null;
    let fillingInterval = null;
    let wateringTimeout = null;
    let autoFillMsgTimeout = null;

    let posts = JSON.parse(localStorage.getItem("communityPosts") || "[]");

    function updateDisplay() {
      tempDisplay.textContent = `온도: ${temperature}°C`;
      humidityDisplay.textContent = `습도: ${humidity}%`;
      waterTankDisplay.textContent = `물탱크: ${waterTankLevel.toFixed(1)}%`;

      // 온도 알람
      if (temperature <= 5) {
        tempAlert.textContent = "⚠️ 경고: 온도가 너무 낮습니다! 식물에 해로울 수 있습니다.";
      } else if (temperature >= 40) {
        tempAlert.textContent = "⚠️ 경고: 온도가 너무 높습니다! 식물에 해로울 수 있습니다.";
      } else {
        tempAlert.textContent = "";
      }

      // 습도 알람
      if (humidity <= 20) {
        humidityAlert.textContent = "⚠️ 경고: 습도가 너무 낮습니다! 식물에 해로울 수 있습니다.";
      } else if (humidity >= 80) {
        humidityAlert.textContent = "⚠️ 경고: 습도가 너무 높습니다! 식물에 해로울 수 있습니다.";
      } else {
        humidityAlert.textContent = "";
      }

      // 물탱크 5% 이하일 때 메시지 5초간 표시
      if (waterTankLevel <= 5) {
        if (!fillingInterval) {
          startFilling();
        }
        if (!autoFillMsgTimeout) {
          waterTankAlert.textContent = "⚠️ 물 부족! 자동으로 물탱크를 채우고 있습니다...";
          autoFillMsgTimeout = setTimeout(() => {
            waterTankAlert.textContent = "";
            autoFillMsgTimeout = null;
          }, 5000);
        }
      } else {
        // 5% 초과 시 경고 및 메시지 초기화
        if (autoFillMsgTimeout) {
          clearTimeout(autoFillMsgTimeout);
          autoFillMsgTimeout = null;
        }
        waterTankAlert.textContent = "";
      }
    }

    function changeTemp(amount) {
      temperature += amount;
      if (temperature < -10) temperature = -10;
      if (temperature > 50) temperature = 50;
      updateDisplay();
    }

    function changeHumidity(amount) {
      humidity += amount;
      if (humidity < 0) humidity = 0;
      if (humidity > 100) humidity = 100;
      updateDisplay();
    }

    function startWatering() {
      if (wateringInterval) return;
      if (waterTankLevel <= 5) {
        alert("물탱크 수위가 너무 낮아 물주기를 시작할 수 없습니다.");
        return;
      }
      wateringInterval = setInterval(() => {
        if (waterTankLevel > 0) {
          waterTankLevel -= 1; // 1%씩 감소
          if (waterTankLevel < 0) waterTankLevel = 0;
          updateDisplay();
        }
      }, 1000);
      wateringStartBtn.disabled = true;
      wateringStopBtn.disabled = false;
      wateringTimedStartBtn.disabled = true;
    }

    function stopWatering() {
      if (wateringInterval) {
        clearInterval(wateringInterval);
        wateringInterval = null;
      }
      wateringStartBtn.disabled = false;
      wateringStopBtn.disabled = true;
      wateringTimedStartBtn.disabled = false;
      updateDisplay();
    }

    function startFilling() {
      if (fillingInterval) return;
      fillingInterval = setInterval(() => {
        if (waterTankLevel < 100) {
          waterTankLevel += 2; // 2%씩 증가
          if (waterTankLevel > 100) waterTankLevel = 100;
          updateDisplay();
          if (waterTankLevel >= 100) {
            stopFilling();
          }
        } else {
          stopFilling();
          updateDisplay();
        }
      }, 1000);
      fillingStartBtn.disabled = true;
      fillingStopBtn.disabled = false;
      wateringTimedStartBtn.disabled = true;
      wateringStartBtn.disabled = true;
      wateringStopBtn.disabled = true;
    }

    function stopFilling() {
      if (fillingInterval) {
        clearInterval(fillingInterval);
        fillingInterval = null;
      }
      fillingStartBtn.disabled = false;
      fillingStopBtn.disabled = true;
      wateringTimedStartBtn.disabled = false;
      wateringStartBtn.disabled = false;
      wateringStopBtn.disabled = true;
      updateDisplay();
    }

    function startWateringForDuration() {
      const seconds = parseInt(wateringDurationInput.value);
      if (isNaN(seconds) || seconds <= 0) {
        alert("물주기 시간을 초 단위로 올바르게 입력하세요.");
        return;
      }
      if (waterTankLevel <= 5) {
        alert("물탱크 수위가 너무 낮아 물주기를 시작할 수 없습니다.");
        return;
      }
      startWatering();
      wateringTimeout = setTimeout(() => {
        stopWatering();
      }, seconds * 1000);
      wateringTimedStartBtn.disabled = true;
    }

    // 커뮤니티 기능
    function addPost() {
      const content = postInput.value.trim();
      if (!content) {
        alert("게시글 내용을 입력해주세요.");
        return;
      }
      const post = {
        id: Date.now(),
        content,
        timestamp: new Date().toISOString(),
        comments: []
      };
      posts.unshift(post);
      postInput.value = "";
      savePosts();
      renderPosts();
    }

    function addComment(postId, commentTextInput) {
      const text = commentTextInput.value.trim();
      if (!text) {
        alert("댓글 내용을 입력해주세요.");
        return;
      }
      const post = posts.find(p => p.id === postId);
      if (!post) return;
      post.comments.push({
        id: Date.now(),
        text,
        timestamp: new Date().toISOString()
      });
      commentTextInput.value = "";
      savePosts();
      renderPosts();
    }

    function savePosts() {
      localStorage.setItem("communityPosts", JSON.stringify(posts));
    }

    function renderPosts() {
      postListDiv.innerHTML = "";
      posts.forEach(post => {
        const postDiv = document.createElement("div");
        postDiv.className = "post";

        const time = new Date(post.timestamp);
        const timeStr = time.toLocaleString();

        const header = document.createElement("div");
        header.style.display = "flex";
        header.style.justifyContent = "space-between";
        header.style.alignItems = "center";

        const timeElem = document.createElement("time");
        timeElem.textContent = timeStr;

        header.appendChild(timeElem);

        const contentP = document.createElement("p");
        contentP.textContent = post.content;

        postDiv.appendChild(header);
        postDiv.appendChild(contentP);

        post.comments.forEach(comment => {
          const commentDiv = document.createElement("div");
          commentDiv.className = "comment";

          const commentTime = new Date(comment.timestamp).toLocaleString();
          commentDiv.textContent = `[${commentTime}] ${comment.text}`;
          postDiv.appendChild(commentDiv);
        });

        const commentInputDiv = document.createElement("div");
        commentInputDiv.className = "comment-input";

        const commentInput = document.createElement("input");
        commentInput.type = "text";
        commentInput.placeholder = "댓글 입력...";

        const commentBtn = document.createElement("button");
        commentBtn.textContent = "등록";
        commentBtn.onclick = () => addComment(post.id, commentInput);

        commentInputDiv.appendChild(commentInput);
        commentInputDiv.appendChild(commentBtn);

        postDiv.appendChild(commentInputDiv);

        postListDiv.appendChild(postDiv);
      });
    }

    updateDisplay();
    renderPosts();
  </script>
</body>
</html>
